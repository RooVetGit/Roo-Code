# GitLab CI/CD Pipeline for Roo Code On-Premises
# 
# ì´ íŒŒì´í”„ë¼ì¸ì€ ì˜¨í”„ë ˆë¯¸ìŠ¤ Roo Code VS Code í™•ì¥ì„ ë¹Œë“œí•˜ê³  ë°°í¬í•©ë‹ˆë‹¤.
# - ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
# - ì™¸ë¶€ í˜¸ì¶œ ì°¨ë‹¨ í…ŒìŠ¤íŠ¸
# - VSIX íŒ¨í‚¤ì§€ ë¹Œë“œ
# - ì•„í‹°íŒ©íŠ¸ ì €ì¥ ë° ë°°í¬

stages:
  - validate
  - test
  - build
  - package
  - deploy

variables:
  # Node.js ë° pnpm ì„¤ì •
  NODE_VERSION: "20.19.2"
  PNPM_VERSION: "10.8.1"
  
  # ì˜¨í”„ë ˆë¯¸ìŠ¤ í™˜ê²½ ë³€ìˆ˜
  ON_PREM: "true"
  NODE_ENV: "production"
  
  # Docker ì´ë¯¸ì§€
  NODE_IMAGE: "node:20.19.2-alpine"
  DOCKER_IMAGE: "docker:27-alpine"

# ê¸°ë³¸ ì„¤ì •
default:
  image: $NODE_IMAGE
  before_script:
    - apk add --no-cache git curl
    - npm install -g pnpm@$PNPM_VERSION
    - pnpm config set store-dir .pnpm-store
    - pnpm install --frozen-lockfile

# ìºì‹œ ì„¤ì •
cache:
  key:
    files:
      - pnpm-lock.yaml
  paths:
    - .pnpm-store/
    - node_modules/
    - src/node_modules/
    - webview-ui/node_modules/

# 1. ì½”ë“œ ê²€ì¦ ë‹¨ê³„
code_quality:
  stage: validate
  script:
    - echo "ğŸ” Running code quality checks..."
    - pnpm lint
    - pnpm check-types
    - echo "âœ… Code quality checks passed"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

# ì™¸ë¶€ í˜¸ì¶œ ê²€ì¦
outbound_detection:
  stage: validate
  script:
    - echo "ğŸ” Detecting external HTTP calls..."
    - pnpm detect-outbound
    - echo "ğŸ“Š External calls detected and cataloged"
  artifacts:
    reports:
      junit: outbound-report.xml
    paths:
      - outbound-urls.json
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

# 2. í…ŒìŠ¤íŠ¸ ë‹¨ê³„
unit_tests:
  stage: test
  script:
    - echo "ğŸ§ª Running unit tests..."
    - pnpm test
    - echo "âœ… Unit tests passed"
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'
  artifacts:
    reports:
      junit: test-results.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

# ì˜¨í”„ë ˆë¯¸ìŠ¤ í†µí•© í…ŒìŠ¤íŠ¸
integration_tests:
  stage: test
  services:
    - name: docker:27-dind
      alias: docker
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - apk add --no-cache git curl docker-compose
    - npm install -g pnpm@$PNPM_VERSION
    - pnpm config set store-dir .pnpm-store
    - pnpm install --frozen-lockfile
  script:
    - echo "ğŸ”¥ Running firewall integration tests..."
    - pnpm test:firewall:docker
    - echo "âœ… Integration tests passed"
  artifacts:
    paths:
      - test-results/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
  allow_failure: true # ì™¸ë¶€ ì˜ì¡´ì„±ìœ¼ë¡œ ì¸í•´ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŒ

# 3. ë¹Œë“œ ë‹¨ê³„
build_extension:
  stage: build
  script:
    - echo "ğŸ—ï¸ Building extension for on-premises..."
    - pnpm build
    - pnpm bundle:onprem
    - echo "âœ… Extension built successfully"
  artifacts:
    paths:
      - src/dist/
      - webview-ui/dist/
    expire_in: 1 day
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

# 4. VSIX íŒ¨í‚¤ì§• ë‹¨ê³„
package_vsix:
  stage: package
  dependencies:
    - build_extension
  script:
    - echo "ğŸ“¦ Packaging on-premises VSIX..."
    - pnpm package:onprem
    - ls -la bin/
    - echo "ğŸ“Š VSIX package information:"
    - cat bin/build-info-onprem.json | head -20
    - echo "âœ… VSIX packaging completed"
  artifacts:
    name: "roo-cline-onprem-${CI_COMMIT_SHA:0:8}"
    paths:
      - bin/*.vsix
      - bin/build-info-onprem.json
    expire_in: 30 days
    reports:
      artifacts:
        file: bin/build-info-onprem.json
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

# VSIX ìœ íš¨ì„± ê²€ì‚¬
validate_vsix:
  stage: package
  dependencies:
    - package_vsix
  script:
    - echo "ğŸ” Validating VSIX package..."
    - apk add --no-cache unzip
    - |
      for vsix in bin/*.vsix; do
        echo "ğŸ“‹ Analyzing $vsix"
        
        # íŒŒì¼ í¬ê¸° í™•ì¸
        size=$(stat -c%s "$vsix")
        echo "  Size: $(echo $size | numfmt --to=iec-i)B"
        
        # VSIX êµ¬ì¡° í™•ì¸
        unzip -t "$vsix" > /dev/null
        echo "  âœ… ZIP structure valid"
        
        # manifest í™•ì¸
        unzip -q "$vsix" extension/package.json -d /tmp/
        if [ -f /tmp/extension/package.json ]; then
          echo "  âœ… Package manifest found"
          name=$(cat /tmp/extension/package.json | grep '"name"' | head -1)
          version=$(cat /tmp/extension/package.json | grep '"version"' | head -1)
          echo "  ğŸ“¦ $name $version"
        else
          echo "  âŒ Package manifest missing"
          exit 1
        fi
        
        # ìµœì†Œ í¬ê¸° í™•ì¸ (1MB)
        if [ $size -lt 1048576 ]; then
          echo "  âŒ VSIX too small: ${size} bytes"
          exit 1
        fi
        
        echo "  âœ… VSIX validation passed"
      done
    - echo "âœ… All VSIX packages validated"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

# 5. ë°°í¬ ë‹¨ê³„
deploy_to_nexus:
  stage: deploy
  dependencies:
    - package_vsix
    - validate_vsix
  script:
    - echo "ğŸš€ Deploying to internal Nexus repository..."
    - |
      if [ -z "$NEXUS_URL" ] || [ -z "$NEXUS_USER" ] || [ -z "$NEXUS_PASSWORD" ]; then
        echo "âš ï¸ Nexus credentials not configured, skipping deployment"
        exit 0
      fi
    - |
      for vsix in bin/*.vsix; do
        filename=$(basename "$vsix")
        echo "ğŸ“¤ Uploading $filename to Nexus..."
        
        curl -u "$NEXUS_USER:$NEXUS_PASSWORD" \
             --upload-file "$vsix" \
             "$NEXUS_URL/repository/vscode-extensions/$filename"
        
        if [ $? -eq 0 ]; then
          echo "âœ… Successfully uploaded $filename"
        else
          echo "âŒ Failed to upload $filename"
          exit 1
        fi
      done
    - echo "âœ… Deployment completed"
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
  environment:
    name: production
    url: $NEXUS_URL

# íƒœê·¸ ë¦´ë¦¬ìŠ¤ (ìˆ˜ë™)
create_release:
  stage: deploy
  dependencies:
    - package_vsix
  script:
    - echo "ğŸ·ï¸ Creating release for tag $CI_COMMIT_TAG..."
    - |
      if [ -z "$CI_COMMIT_TAG" ]; then
        echo "âŒ This job should only run on tags"
        exit 1
      fi
    - |
      # Release APIë¥¼ í†µí•œ ë¦´ë¦¬ìŠ¤ ìƒì„±
      curl --request POST \
           --header "PRIVATE-TOKEN: $CI_JOB_TOKEN" \
           --data name="Roo Code On-Premises $CI_COMMIT_TAG" \
           --data tag_name="$CI_COMMIT_TAG" \
           --data description="On-premises version of Roo Code VS Code extension" \
           "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases"
    - echo "âœ… Release created for $CI_COMMIT_TAG"
  rules:
    - if: $CI_COMMIT_TAG
      when: manual

# ë²¤ì¹˜ë§ˆí¬ (ì„ íƒì )
benchmark_local_llm:
  stage: test
  script:
    - echo "âš¡ Running local LLM benchmarks..."
    - pnpm benchmark-local-llm || echo "âš ï¸ Benchmark failed (expected in CI)"
    - echo "ğŸ“Š Benchmark completed"
  artifacts:
    paths:
      - benchmark-results.json
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
    - if: $CI_COMMIT_TAG
      when: manual
  allow_failure: true

# ì •ë¦¬ ì‘ì—…
cleanup:
  stage: .post
  script:
    - echo "ğŸ§¹ Cleaning up temporary files..."
    - rm -rf .pnpm-store/
    - rm -rf node_modules/.cache/
    - echo "âœ… Cleanup completed"
  when: always
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

# Workflow rules
workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "web" 